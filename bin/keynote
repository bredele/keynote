#!/usr/bin/env node

var fs = require('fs'),
		read = fs.readFileSync,
		write = fs.writeFile,
		resolve = require('path').resolve,
		program = require('commander'),
		ncp = require('ncp'),
		mkdir = require('mkdirp').sync,
		walk = require('./walk'),
		serve = require('./serve');


function supplant(text, data){
  return text.replace(/\{\{([^}]+)\}\}/g, function(_, expr) {
    return data[expr.trim()] || '';
  });
}

/**
 * Usage.
 */

program
  .version(require('../package.json').version)
  .option('-o, --output <output>', 'create keynote directory with output')
  .option('-p, --path <path>', 'run keynote on path', '.')



/**
 * Examples.
 */

program.on('--help', function () {
  console.log('  Examples:');
});


/**
 * Parse.
 */

program.parse(process.argv);


// path

var output = program.output || './keynote';

//create output directory

mkdir(output);

//update output directory

ncp(__dirname + '/basic', output, function(err) {
	if(err) throw err;
	var file = read(output + '/index.html', {
		encoding: 'utf-8'
	});
	write(output + '/index.html', supplant(file, {
		title: 'keynote',
		keynote: walk(resolve(program.path))
	}), function() {
		if(err) throw err;
	});
});


serve(output);